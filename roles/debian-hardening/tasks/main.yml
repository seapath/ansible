# Copyright (C) 2022, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0
---

- name: "Add kernel parameters in grub"
  lineinfile:
    dest: /etc/default/grub
    regexp: "^(GRUB_CMDLINE_LINUX=(?!.* {{ item }})\"[^\"]*)(\".*)"
    line: '\1 {{ item }}\2'
    state: present
    backrefs: yes
  register: updategrub
  with_items: "{{ kernel_params }}"
  notify: update-grub
  when: not revert

- name: "Revert kernel parameters added in grub"
  lineinfile:
    dest: /etc/default/grub
    regexp: "^(GRUB_CMDLINE_LINUX=\".*)( {{ item }})(.*\")$"
    line: '\1\3'
    state: present
    backrefs: yes
  register: updategrub
  with_items: "{{ kernel_params }}"
  notify: update-grub
  when: revert


- name: "Disable coredumps"
  lineinfile:
    dest: /etc/sysctl.d/50-coredump.conf
    regexp: "^kernel.core_pattern=/dev/null$"
    line: "kernel.core_pattern=/dev/null"
    create: yes
    state: present
  notify: update sysfs values using sysctl
  when: not revert
- name: "Revert coredump disabling"
  lineinfile:
    dest: /etc/sysctl.d/50-coredump.conf
    regexp: "^kernel.core_pattern=/dev/null$"
    state: absent
  notify: update sysfs values using sysctl
  when: revert

- name: "Disable kexec"
  lineinfile:
    dest: /etc/sysctl.d/50-kexec.conf
    regexp: "^kernel.kexec_load_disabled=1$"
    line: "kernel.kexec_load_disabled=1"
    create: yes
    state: present
  notify: update-sysfs
  when: not revert
- name: "Revert kexec disabling"
  lineinfile:
    dest: /etc/sysctl.d/50-kexec.conf
    regexp: "^kernel.kexec_load_disabled=1$"
    state: absent
  notify: update-sysfs
  when: revert
