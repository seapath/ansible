# Copyright (C) 2025 RTE
# SPDX-License-Identifier: Apache-2.0

---
- name: Find boot entry for DVD-ROM
  command: efibootmgr
  register: boot_entries
  changed_when: false

- name: Find line containing DVD-ROM
  set_fact:
    dvd_bootline: "{{ boot_entries.stdout_lines | select('search', 'DVD-ROM') | list | first | default('') }}"

- name: Fail if no DVD-ROM boot entry found
  fail:
    msg: "No boot entry containing 'DVD-ROM' found."
  when: dvd_bootline == ''

- name: Extract boot number from line
  set_fact:
    dvd_bootnum: "{{ dvd_bootline | regex_search('Boot([0-9A-Fa-f]{4})', '\\1') | first | default('') }}"

- name: Debug bootnum
  debug:
    msg: "Boot number for DVD-ROM: {{ dvd_bootnum }}"

- name: Set next boot entry to DVD-ROM
  command: "efibootmgr -n {{ dvd_bootnum }}"
  changed_when: true
  when: dvd_bootnum is defined

- name: Reboot for ISO installation to happen
  reboot:
    reboot_command: systemctl reboot --force
    reboot_timeout: 1500
