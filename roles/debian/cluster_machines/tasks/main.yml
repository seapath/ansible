- name: Synchronization of backup-restore folder on the control machine to dest on the remote hosts
  ansible.posix.synchronize:
    src: ../src/debian/backup-restore/
    dest: /usr/local/bin/
    rsync_opts:
      - "--chown=root:root"
      - "--exclude=*.j2"
- name: Copy backup-restore templates
  template:
    src: ../src/debian/backup-restore/{{ item.src }}
    dest: /usr/local/bin/{{ item.dest }}
    mode: '0755'
  with_items:
    - src:
        restore_vm.sh.j2
      dest:
        restore_vm.sh

- name: Add extra modules to the kernel
  lineinfile:
    dest: /etc/modules
    state: present
    regexp: "^{{ item }}$"
    line: "{{ item }}"
  with_items: "{{ extra_kernel_modules | default([]) }}"

- name: Synchronization of src python3-setup-ovs on the control machine to dest on the remote hosts
  ansible.posix.synchronize:
    src: ../src/debian/python3-setup-ovs
    dest: /tmp/src
    rsync_opts:
      - "--chown=root:root"
- name: Install python3-setup-ovs
  command:
    cmd: /usr/bin/python3 setup.py install
    chdir: /tmp/src/python3-setup-ovs
- name: Copy votp-config_ovs.service
  ansible.builtin.copy:
    src: ../src/debian/votp-config_ovs.service
    dest: /etc/systemd/system/votp-config_ovs.service
    mode: '0644'
  register: votpconfigovs
- name: daemon-reload votp-config_ovs
  ansible.builtin.service:
    daemon_reload: yes
  when: votpconfigovs.changed
- name: enable votp-config_ovs.service
  ansible.builtin.systemd:
    name: votp-config_ovs.service
    enabled: yes

- name: get Debian-snmp uid
  getent:
    database: passwd
    key: "Debian-snmp"
- name: get Debian-snmp gid
  getent:
    database: group
    key: "Debian-snmp"
- debug:
    msg:
      - "user id {{ getent_passwd['Debian-snmp'][1] }}"
      - "group id {{ getent_group['Debian-snmp'][1] }}"

- name: Set Debian-snmp correct uid/gid
  block:
    - name: stop snmpd if needed
      ansible.builtin.systemd:
        name: snmpd.service
        state: stopped
    - name: Ensure group "Debian-snmp" exists with correct gid
      ansible.builtin.group:
        name: Debian-snmp
        state: present
        gid: 902
    - name: Ensure user Debian-snmp has correct uid and gid
      user:
        name: Debian-snmp
        uid: 902
        group: Debian-snmp
    - name: restart snmpd
      ansible.builtin.systemd:
        name: snmpd.service
        state: started
  when: getent_passwd['Debian-snmp'][1] != "902" or getent_group['Debian-snmp'][1] != "902"

- name: Synchronization of snmp_ scripts
  ansible.posix.synchronize:
    src: ../src/debian/
    dest: /usr/local/bin/
    rsync_opts:
    - "--include=snmp_*.sh"
    - "--include=virt-df.sh"
    - "--exclude=*"
    - "--chmod=F755"
    - "--chown=root:root"
- name: Snmp config
  ansible.builtin.template:
    src: ../src/debian/snmpd.conf.j2
    dest: /etc/snmp/snmpd.conf
    mode: '0644'
  register: snmpd_conf
- name: Wait for DHCP for SNMP
  lineinfile:
    dest: /lib/systemd/system/snmpd.service
    regexp: "^After="
    line: "After=network-online.target"
    state: present
- name: restart snmpd
  ansible.builtin.systemd:
    name: snmpd.service
    state: restarted
  when: snmpd_conf.changed

- name: Install sudo Debian-snmp user rules
  copy:
    src: ../src/debian/sudoers/Debian-snmp
    dest: /etc/sudoers.d/Debian-snmp
    owner: root
    group: root
    mode: '0440'
