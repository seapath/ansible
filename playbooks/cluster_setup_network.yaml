# Copyright (C) 2020, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0

# This Ansible playbook configures the networks and defines the hostnames. It
# can be used on cluster machines and VMs. It is called by the playbook
# cluster_setup_main.yaml, but can also be called independently, especially to
# configure VMs.

---
- name: Configure OVS
  hosts: hypervisors
  vars:
      apply_config: "{{ apply_network_config | default(false) }}"
  tasks:
      - name: Create OVS configuration
        template:
          src: ../templates/ovs_configuration.json.j2
          dest: /etc/ovs_configuration.json
          validate: setup_ovs.py -v -c -f %s
      - name: Restart votp-config_ovs
        ansible.builtin.systemd:
            name: votp-config_ovs
            state: restarted
        when:
            apply_config

- name: Configure Network
  hosts: cluster_machines
  vars_files:
    - ../vars/network_vars.yml
  roles:
    - systemd_networkd

- name: Network configuration
  hosts: cluster_machines
  vars:
      apply_config: "{{ apply_network_config | default(false) }}"
  tasks:
      - name: Restart systemd-networkd
        ansible.builtin.systemd:
            name: systemd-networkd
            state: restarted
        when:
            apply_config

- name: Configure hosts and hostname
  hosts: cluster_machines
  tasks:
      - name: Set hostname
        hostname:
            name: "{{ inventory_hostname }}"
            use: systemd
      - name: Build hosts file
        lineinfile:
            dest: /etc/hosts
            regexp: '.*{{ item }}$'
            line: "{{ hostvars[item].ip_addr }} {{item}}"
            state: present
        when: hostvars[item].ip_addr is defined
        loop: "{{ groups['cluster_machines'] }}"
      - name: Add rbd in hosts file
        replace:
            path: /etc/hosts
            regexp: '^{{ ip_addr }} {{ inventory_hostname }}$'
            replace: '{{ ip_addr }} rbd {{ inventory_hostname }}'

- name: Configure NTP
  hosts: cluster_machines
  tasks:
      - name: Set NTP configuration in /etc/systemd/timesyncd.conf
        lineinfile:
            dest: /etc/systemd/timesyncd.conf
            regexp: '{{ item.regexp }}'
            line: '{{ item.line   }}'
            insertafter: '\[Time\]'
            backrefs: true
            create: true
            state: present
        with_items:
            - regexp: '^\s*#?\s*(NTP=).*$'
              line: 'NTP={{ ntp_servers }}'

            - regexp: '^\s*#?\s*(FallbackNTP=).*$'
              line: 'FallbackNTP={{ fallback_ntp_servers | default("") }}'
        notify:
            - Restart systemd timesyncd

  handlers:
      - name: Restart systemd timesyncd
        ansible.builtin.service:
            name: systemd-timesyncd
            state: restarted
