- name: configure snmp
  block:
  - name: get Debian-snmp uid
    getent:
      database: passwd
      key: "Debian-snmp"
  - name: get Debian-snmp gid
    getent:
      database: group
      key: "Debian-snmp"
  - debug:
      msg:
        - "user id {{ getent_passwd['Debian-snmp'][1] }}"
        - "group id {{ getent_group['Debian-snmp'][1] }}"

  - name: Set Debian-snmp correct uid/gid
    block:
      - name: stop snmpd if needed
        ansible.builtin.systemd:
          name: snmpd.service
          state: stopped
      - name: Ensure group "Debian-snmp" exists with correct gid
        ansible.builtin.group:
          name: Debian-snmp
          state: present
          gid: 902
      - name: Ensure user Debian-snmp has correct uid and gid
        user:
          name: Debian-snmp
          uid: 902
          group: Debian-snmp
    when: getent_passwd['Debian-snmp'][1] != "902" or getent_group['Debian-snmp'][1] != "902"

  - name: Synchronization of src snmp_passpersist python module
    ansible.posix.synchronize:
      src: ../src/snmp_passpersist
      dest: /tmp/src
      rsync_opts:
        - "--chown=root:root"
  - name: Install snmp_passpersist
    command:
      cmd: /usr/bin/python3 setup.py install
      chdir: /tmp/src/snmp_passpersist

  - name: Synchronization of snmp_ scripts
    ansible.posix.synchronize:
      src: ../src/debian/snmp/
      dest: /usr/local/bin/
      rsync_opts:
      - "--include=virt-df.sh"
      - "--exclude=*"
      - "--chmod=F755"
      - "--chown=root:root"
  - name: Snmp config
    ansible.builtin.template:
      src: ../src/debian/snmp/snmpd.conf.j2
      dest: /etc/snmp/snmpd.conf
      mode: '0644'
      owner: root
      group: root
    register: snmpd_conf
  - name: SNMP PASS AGENT script run by net-snmp for seapath tree
    copy:
      src: ../src/debian/snmp/exposeseapathsnmp.py
      dest: "/usr/local/bin/exposeseapathsnmp.py"
      mode: '0755'
  - name: script run by cron job to generate snmp data
    copy:
      src: ../src/debian/snmp/snmp_getdata.py
      dest: "/usr/local/sbin/snmp_getdata.py"
      mode: '0755'
  - name: cron job to generate snmp data
    copy:
      src: ../src/debian/snmp/seapathsnmp.cron
      dest: "/etc/cron.d/seapathsnmp"
      mode: '0644'
  - name: Wait for DHCP for SNMP
    lineinfile:
      dest: /lib/systemd/system/snmpd.service
      regexp: "^After="
      line: "After=network-online.target"
      state: present

  - name: restart snmpd
    ansible.builtin.systemd:
      name: snmpd.service
      state: restarted
      enabled: yes

  - name: Install sudo Debian-snmp user rules
    template:
      src: ../src/debian/sudoers/Debian-snmp.j2
      dest: /etc/sudoers.d/Debian-snmp
      owner: root
      group: root
      mode: '0440'
  when: snmp_admin_ip_addr is defined

- name: Disable snmp if it is not needed
  systemd:
    name: snmpd.service
    state: stopped
    enabled: no
  when: snmp_admin_ip_addr is not defined

