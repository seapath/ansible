# Copyright (C) 2023, RTE (http://www.rte-france.com)
# Copyright (C) 2024, SFL (https://savoirfairelinux.com)
# SPDX-License-Identifier: Apache-2.0
# Deploy all VMs define in the VMs group

---
- name: Deploy VMs on cluster
  hosts: "{{ groups.hypervisors[0] }}"
  gather_facts: false
  become: true
  tasks:
    - name: "Deploy VMs"
      include_tasks: tasks/deploy_vm.yaml
      loop: "{{ groups['VMs'] }}"
      vars:
        disk_copy: true
        vm_file: "{{ hostvars[item].vm_disk | default( (vms_disks_directory|default('')) ~ '/' ~ item ~ '.qcow2') }}"
        vm_file_dest: "{{ qcow2tmpuploadfolder | default('/tmp') + '/os.qcow2' }}"
    - name: "Define colocation constraints"
      include_tasks: tasks/colocation.yaml
      loop: "{{ groups['VMs'] }}"
