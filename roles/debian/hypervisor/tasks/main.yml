- name: create src folder on hosts
  file:
    path: /tmp/src
    state: directory
    mode: '0755'

- name: Synchronization of src python3-setup-ovs on the control machine to dest on the remote hosts
  ansible.posix.synchronize:
    src: ../src/debian/python3-setup-ovs
    dest: /tmp/src
    rsync_opts:
      - "--chown=root:root"
- name: Install python3-setup-ovs
  command:
    cmd: /usr/bin/python3 setup.py install
    chdir: /tmp/src/python3-setup-ovs
- name: Copy votp-config_ovs.service
  ansible.builtin.copy:
    src: ../src/debian/votp-config_ovs.service
    dest: /etc/systemd/system/votp-config_ovs.service
    mode: '0644'
  register: votpconfigovs
- name: daemon-reload votp-config_ovs
  ansible.builtin.service:
    daemon_reload: yes
  when: votpconfigovs.changed
- name: enable votp-config_ovs.service
  ansible.builtin.systemd:
    name: votp-config_ovs.service
    enabled: yes

- name: Synchronization of src vm_manager on the control machine to dest on the remote hosts
  ansible.posix.synchronize:
    src: ../src/debian/vm_manager
    dest: /tmp/src
    rsync_opts:
      - "--chown=root:root"
- name: Install vm_manager
  command:
    cmd: /usr/bin/python3 setup.py install
    chdir: /tmp/src/vm_manager
- name: Create a symbolic link
  ansible.builtin.file:
    src: /usr/local/bin/vm_manager_cmd.py
    dest: /usr/local/bin/vm-mgr
    state: link

- name: Copy consolevm.sh
  template:
    src: ../src/debian/consolevm.sh.j2
    dest: /usr/local/bin/consolevm
    mode: '0755'

- name: create /usr/lib/ocf/resource.d/seapath on hosts
  file:
    path: /usr/lib/ocf/resource.d/seapath
    state: directory
    mode: '0755'

- name: Copy Pacemaker Seapath Resource-Agent files
  ansible.posix.synchronize:
    src: ../src/debian/pacemaker_ra/
    dest: /usr/lib/ocf/resource.d/seapath/
    rsync_opts:
    - "--chmod=F755"
    - "--chown=root:root"

- name: Create libvirtd.service.d directory
  file:
    path: /etc/systemd/system/libvirtd.service.d/
    state: directory
    owner: root
    group: root
    mode: 0755
- name: Copy libvirtd.service drop-in
  ansible.builtin.copy:
    src: ../src/debian/libvirtd_override.conf
    dest: /etc/systemd/system/libvirtd.service.d/override.conf
    owner: root
    group: root
    mode: 0644
  notify: daemon-reload
- name: Create pacemaker.service.d directory
  file:
    path: /etc/systemd/system/pacemaker.service.d/
    state: directory
    owner: root
    group: root
    mode: 0755
- name: Copy pacemaker.service drop-in
  ansible.builtin.copy:
    src: ../src/debian/pacemaker_override.conf
    dest: /etc/systemd/system/pacemaker.service.d/override.conf
    owner: root
    group: root
    mode: 0644
  notify: daemon-reload
  register: pacemaker_corosync
- name: Get Pacemaker service Status
  ansible.builtin.systemd:
    name: "pacemaker.service"
  register: pacemaker_service_status
- name: disable pacemaker (reinstall step 1/2)
  ansible.builtin.systemd:
    name: pacemaker.service
    enabled: no
  when: pacemaker_corosync.changed and pacemaker_service_status.status.UnitFileState == "enabled"
- name: enable pacemaker (reinstall step 2/2)
  ansible.builtin.systemd:
    name: pacemaker.service
    enabled: yes
  when: pacemaker_corosync.changed and pacemaker_service_status.status.UnitFileState == "enabled"

- name: Add admin user to libvirt and haclient groups
  user:
    name: "{{ admin_user }}"
    groups: libvirt,haclient
    append: yes
- name: Adding live-migration user
  user:
    name: "{{ livemigration_user }}"
    shell: /bin/bash
    group: libvirt
    uid: 1001
    append: no
  when: livemigration_user is defined and livemigration_user != admin_user

- name: get Debian-snmp uid
  getent:
    database: passwd
    key: "Debian-snmp"
- name: get Debian-snmp gid
  getent:
    database: group
    key: "Debian-snmp"
- debug:
    msg:
      - "user id {{ getent_passwd['Debian-snmp'][1] }}"
      - "group id {{ getent_group['Debian-snmp'][1] }}"

- name: Set Debian-snmp correct uid/gid
  block:
    - name: stop snmpd if needed
      ansible.builtin.systemd:
        name: snmpd.service
        state: stopped
    - name: Ensure group "Debian-snmp" exists with correct gid
      ansible.builtin.group:
        name: Debian-snmp
        state: present
        gid: 902
    - name: Ensure user Debian-snmp has correct uid and gid
      user:
        name: Debian-snmp
        uid: 902
        group: Debian-snmp
    - name: restart snmpd
      ansible.builtin.systemd:
        name: snmpd.service
        state: started
  when: getent_passwd['Debian-snmp'][1] != "902" or getent_group['Debian-snmp'][1] != "902"

- name: Synchronization of snmp_ scripts
  ansible.posix.synchronize:
    src: ../src/debian/
    dest: /usr/local/bin/
    rsync_opts:
    - "--include=snmp_*.sh"
    - "--include=virt-df.sh"
    - "--exclude=*"
    - "--chmod=F755"
    - "--chown=root:root"
- name: Snmp config
  ansible.builtin.template:
    src: ../src/debian/snmpd.conf.j2
    dest: /etc/snmp/snmpd.conf
    mode: '0644'
  register: snmpd_conf
- name: Wait for DHCP for SNMP
  lineinfile:
    dest: /lib/systemd/system/snmpd.service
    regexp: "^After="
    line: "After=network-online.target"
    state: present
- name: restart snmpd
  ansible.builtin.systemd:
    name: snmpd.service
    state: restarted
  when: snmpd_conf.changed

- name: Install sudo Debian-snmp user rules
  copy:
    src: ../src/debian/sudoers/Debian-snmp
    dest: /etc/sudoers.d/Debian-snmp
    owner: root
    group: root
    mode: '0440'

- name: Creating libvirt user with libvirtd permissions
  user: name=libvirt
    group=libvirt
    shell=/bin/false

- name: Copy sysctl rules
  ansible.builtin.copy:
    src: ../src/debian/{{ item }}
    dest: /etc/sysctl.d/{{ item }}
    mode: '0644'
  with_items:
    - 00-bridge_nf_call.conf

- name: add br_netfilter to /etc/modules
  lineinfile:
    dest: /etc/modules
    state: present
    regexp: '^br_netfilter$'
    line: 'br_netfilter'
- name: add raid6_pq to /etc/modules
  lineinfile:
    dest: /etc/modules
    state: present
    regexp: '^raid6_pq$'
    line: 'raid6_pq'

- name: Copy apparmor libvirt-qemu rules
  ansible.builtin.copy:
    src: ../src/debian/etc_apparmor.d_abstractions_libvirt-qemu.conf
    dest: /etc/apparmor.d/abstractions/libvirt-qemu
    mode: '0644'

- name: lineinfile in hosts file for logstash-seapath
  lineinfile:
    dest: /etc/hosts
    regexp: '.* logstash-seapath$'
    line: "{{ logstash_server_ip }} logstash-seapath"
    state: present

- name: Make libvirt use the "machine-id" way to determine host UUID
  lineinfile:
    dest: /etc/libvirt/libvirtd.conf
    regexp: "^#?host_uuid_source ="
    line: "host_uuid_source = \"machine-id\""
    state: present
- name: restart libvirtd
  ansible.builtin.systemd:
    name: libvirtd.service
    state: restarted

- name: enable docker.service
  ansible.builtin.systemd:
    name: docker.service
    enabled: yes
    state: started
- name: enable docker.socket
  ansible.builtin.systemd:
    name: docker.socket
    enabled: yes
    state: started

- name: add vhost_vsock to /etc/modules
  lineinfile:
    dest: /etc/modules
    state: present
    regexp: '^vhost_vsock$'
    line: 'vhost_vsock'

- name: Copy votp-taskset.service script
  template:
    src: ../src/debian/taskset_boot.sh.j2
    dest: /usr/local/bin/taskset_boot.sh
    mode: '0755'
  register: votptaskset1
- name: Copy votp-taskset.service
  ansible.builtin.copy:
    src: ../src/debian/votp-taskset.service
    dest: /etc/systemd/system/votp-taskset.service
    mode: '0644'
  register: votptaskset2
- name: daemon-reload taskset
  ansible.builtin.service:
    daemon_reload: yes
  when: votptaskset1.changed or votptaskset2.changed
- name: enable votp-taskset.service
  ansible.builtin.systemd:
    name: votp-taskset.service
    enabled: yes

- name: Copy sysctl RT rules
  ansible.builtin.copy:
    src: ../src/debian/{{ item }}
    dest: /etc/sysctl.d/{{ item }}
    mode: '0644'
  with_items:
    - 00-schedrt.conf

- name: add sriov driver to /etc/modules
  lineinfile:
    dest: /etc/modules
    state: present
    regexp: "^{{ sriov_driver }}$"
    line: "{{ sriov_driver }}"
  when: sriov_driver is defined
- name: add sriov apparmor permission for libvirt
  lineinfile:
    dest: /etc/apparmor.d/local/abstractions/libvirt-qemu
    state: present
    line: '/dev/vfio/* rw,'
    create: yes
    mode: 0644
  when: sriov_driver is defined
- name: load the sriov module
  community.general.modprobe:
    name: "{{ sriov_driver }}"
    state: present
  when: sriov_driver is defined

- name: add sriov sysfs rules
  ansible.builtin.lineinfile:
    dest: "/etc/sysfs.d/sriov.conf"
    state: present
    regexp: "^class/net/{{ item.key }}/device/sriov_numvfs = "
    line: "class/net/{{ item.key }}/device/sriov_numvfs = {{ item.value }}"
    create: yes
    mode: 0644
  with_items: "{{ sriov | dict2items }}"
  when: sriov is defined
  register: sriov_sysfs
- name: Copy sysfs.d cpumask
  template:
    src: ../templates/00-workqueue_cpumask.conf.j2
    dest: /etc/sysfs.d/00-workqueue_cpumask.conf
    mode: '0644'
  register: sysfscpumask
- name: restart sysfsutils
  ansible.builtin.systemd:
    name: sysfsutils.service
    state: restarted
  when: sysfscpumask.changed or sriov_sysfs.changed

- name: "grub conf hypervisor"
  lineinfile:
    dest: /etc/default/grub
    regexp: "^(GRUB_CMDLINE_LINUX=(?!.* {{ item }})\"[^\"]*)(\".*)"
    line: '\1 {{ item }}\2'
    state: present
    backrefs: yes
  register: updategrub1
  with_items:
    - processor.max_cstate=1
    - intel_idle.max_cstate=1
    - cpufreq.default_governor=performance
    - hugepagesz=1G
    - no_debug_objects
    - intel_pstate=disable
    - nosoftlockup
    - "rcu_nocbs={{ cpumachinesrt }}"
    - rcu_nocb_poll
    - rcutree.kthread_prio=10
    - "isolcpus=nohz,domain,managed_irq,{{ cpumachinesrt }}"
    - skew_tick=1
    - tsc=reliable

- name: update-grub
  command: update-grub
  when: updategrub1.changed

- name: "irqbalance conf"
  lineinfile:
    dest: /etc/default/irqbalance
    regexp: '^IRQBALANCE_BANNED_CPUS=".*"$'
    line: 'IRQBALANCE_BANNED_CPUS="{{ irqmask }}"'
    state: present
  register: irqbalanceconf
- name: restart irqbalance
  ansible.builtin.systemd:
    name: irqbalance.service
    enabled: yes
    state: restarted
  when: irqbalanceconf.changed

- name: "systemd conf CPUAffinity"
  lineinfile:
    dest: /etc/systemd/system.conf
    regexp: '^CPUAffinity=.*$'
    line: "CPUAffinity={{ cpusystem }}"
    state: present
- name: "systemd conf RuntimeWatchdogSec"
  lineinfile:
    dest: /etc/systemd/system.conf
    regexp: '^RuntimeWatchdogSec=.*$'
    line: "RuntimeWatchdogSec=20"
    state: present
- name: "systemd conf RebootWatchdogSec"
  lineinfile:
    dest: /etc/systemd/system.conf
    regexp: '^RebootWatchdogSec=.*$'
    line: "RebootWatchdogSec=5min"
    state: present

- name: Create systemd slices override
  file:
    path: /etc/systemd/system.control/{{ item }}.slice.d
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items:
    - "system"
    - "user"
    - "machine"
- name: create systemd slices override
  template:
    src: ../templates/systemd_slice_override.j2
    dest: /etc/systemd/system.control/{{ item.name }}.slice.d/50-AllowedCPUs.conf
    owner: root
    group: root
    mode:  0644
  with_items:
    - { name: "system", description: "system slice", allowedcpus: "{{ cpusystem }}" }
    - { name: "user", description: "user slice", allowedcpus: "{{ cpuuser }}" }
    - { name: "machine", description: "machine slice", allowedcpus: "{{ cpumachines }}" }

- name: create systemd slices
  template:
    src: ../templates/systemd_slice.j2
    dest: /etc/systemd/system/{{ item.name }}.slice
    owner: root
    group: root
    mode:  0644
  with_items:
    - { name: "machine-rt", description: "VM rt slice", wants: "machine.slice", allowedcpus: "{{ cpumachinesrt }}" }
    - { name: "machine-nort", description: "VM nonrt slice", wants: "machine.slice", allowedcpus: "{{ cpumachinesnort }}" }
    - { name: "ovs", description: "ovs slice", wants: "", allowedcpus: "{{ cpuovs }}" }
  register: newslices

- name: start new slices
  ansible.builtin.systemd:
    name: "{{ item }}.slice"
    state: restarted
    daemon_reload: yes
  with_items:
    - "machine-rt"
    - "machine-nort"
    - "ovs"
  when: newslices.changed

- name: Create ovs-vswitchd.service.d directory
  file:
    path: /etc/systemd/system/ovs-vswitchd.service.d/
    state: directory
    owner: root
    group: root
    mode: 0755
- name: Copy ovs-vswitchd.service drop-in
  ansible.builtin.copy:
    src: ../src/debian/ovs-vswitchd_override.conf
    dest: /etc/systemd/system/ovs-vswitchd.service.d/override.conf
    owner: root
    group: root
    mode: 0644
  register: ovsvswitchd
- name: Restart ovs-vswitchd
  ansible.builtin.systemd:
    state: restarted
    daemon_reload: yes
    name: ovs-vswitchd
  when: ovsvswitchd.changed


- name: Copy ptp_status executable files
  ansible.builtin.copy:
    src: ../src/debian/ptpstatus/{{ item }}
    dest: /usr/local/bin/{{ item }}
    mode: '0755'
  with_items:
    - ptpstatus.sh
- name: Copy ptp_vsock executable files
  ansible.builtin.copy:
    src: ../src/debian/ptp_vsock.py
    dest: /usr/local/bin/ptp_vsock.py
    mode: '0755'

- name: Copy ptp_status.service
  ansible.builtin.copy:
    src: ../src/debian/ptpstatus/ptpstatus.service
    dest: /etc/systemd/system/ptpstatus.service
    mode: '0644'
  register: ptpstatus
- name: Copy ptp_vsock.service
  ansible.builtin.copy:
    src: ../src/debian/ptp_vsock.service
    dest: /etc/systemd/system/ptp_vsock.service
    mode: '0644'
  register: ptpvsock
- name: daemon-reload ptp status
  ansible.builtin.service:
    daemon_reload: yes
  when: ptpstatus.changed or ptpvsock.changed
- name: enable ptpstatus.service
  ansible.builtin.systemd:
    name: ptpstatus.service
    enabled: yes
    state: started
- name: enable ptp_vsock.service
  ansible.builtin.systemd:
    name: ptp_vsock.service
    enabled: yes
    state: started
