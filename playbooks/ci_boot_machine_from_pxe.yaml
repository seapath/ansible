# Copyright (C) 2021, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0
# This Ansible playbook start machines and ensure the PXE flash image is
# running on it.
---
- name: Launch PXE server on CI
  hosts: localhost
  tasks:
      - name: Create PXE configuration file
        template:
            src: ../templates/pxe_extra_config.conf.j2
            dest: "{{ playbook_dir }}/pxe_extra_config.conf"
      - name: Start the PXE server
        docker_container:
            recreate: true
            network_mode: host
            volumes:
                - "{{ playbook_dir }}/../pxe_images:/tftpboot/syslinux/images:ro"
                - "{{ playbook_dir }}/pxe_extra_config.conf:/etc/dnsmasq.d/pxe_extra_config.conf:ro"
            auto_remove: true
            state: "started"
            image: "seapath-pxe:latest"
            name: "seapath_flash_pxe"
            capabilities:
                - "net_admin"
                - "net_raw"
            env:
                DHCP_RANGE_BEGIN: "{{ dhcp_range_begin }}"
                DHCP_RANGE_END: "{{ dhcp_range_end }}"
                BIND_INTERFACE: "{{ dhcp_bind_interface }}"
                SERVER_ADDRESS: "{{ pxe_server_address }}"
                PXE: "bios"
- import_playbook: ci_restart_machines.yaml
  vars:
      machines: pxe_machines
- name: Check all machines have boot on the flash-pxe image
  hosts: pxe_machines
  tasks:
      - name: "Check {{ inventory_hostname }} have boot on the flash-pxe image"
        lineinfile:
            path: /etc/os-release
            state: present
            line: NAME="Seapath Flash Yocto distribution"
        check_mode: true
- name: Stop the PXE server
  hosts: localhost
  tasks:
      - name: Stop ci_pxe container
        docker_container:
            state: "stopped"
            name: "seapath_flash_pxe"
