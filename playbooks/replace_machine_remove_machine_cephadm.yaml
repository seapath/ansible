# Copyright (C) 2025, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0

# Removes a machine from the Ceph cluster using cephadm-ansible modules.
# Uses graceful drain when the machine is online, forced removal otherwise.
#
# Required extra vars:
#   machine_to_remove: inventory name of the host to remove

---
- name: Sanity check
  hosts: localhost
  pre_tasks:
    - name: Exit playbook, if no machine was given
      fail:
        msg: "machine_to_remove must be declared"
      when: machine_to_remove is undefined

- name: Remove node from pacemaker and ceph
  hosts: cluster_machines
  become: true
  tasks:
    - name: Set fact with hostname of machine_to_remove
      set_fact:
        machine_to_remove_hostname: "{{ hostvars[machine_to_remove]['hostname'] }}"

    - name: Define first_node excluding machine_to_remove
      set_fact:
        first_node: "{{ (groups['cluster_machines'] | difference([machine_to_remove]))[0] }}"

    - name: Check if machine_to_remove is reachable
      command: ping -c 1 -W 2 {{ machine_to_remove }}
      register: machine_ping
      failed_when: false
      changed_when: false
      delegate_to: "{{ first_node }}"
      run_once: true

    - name: Set machine online status
      set_fact:
        machine_is_online: "{{ machine_ping.rc == 0 }}"
      run_once: true

    # === Graceful drain (if machine is online) ===
    - name: Drain host gracefully (if online) # noqa: run-once[task]
      ceph.cephadm.ceph_orch_host:
        name: "{{ machine_to_remove_hostname }}"
        state: drain
      delegate_to: "{{ first_node }}"
      run_once: true
      when: machine_is_online | bool

    - name: Wait for all daemons to be drained # noqa: run-once[task]
      command: ceph orch ps {{ machine_to_remove_hostname }} --format json
      register: drain_ps_check
      until: (drain_ps_check.stdout | from_json | length) == 0
      retries: 60
      delay: 10
      delegate_to: "{{ first_node }}"
      run_once: true
      changed_when: false
      when: machine_is_online | bool

    # === Remove host from Ceph ===
    - name: Remove host from Ceph orchestrator (graceful) # noqa: run-once[task]
      ceph.cephadm.ceph_orch_host:
        name: "{{ machine_to_remove_hostname }}"
        state: absent
      delegate_to: "{{ first_node }}"
      run_once: true
      when: machine_is_online | bool

    - name: Remove host from Ceph orchestrator (forced, offline) # noqa: run-once[task]
      command: "ceph orch host rm {{ machine_to_remove_hostname }} --force --offline"
      delegate_to: "{{ first_node }}"
      run_once: true
      changed_when: true
      when: not (machine_is_online | bool)

    # === Remove from pacemaker ===
    - name: Remove machine from pacemaker-corosync cluster # noqa: run-once[task]
      command: "crm_node -R {{ machine_to_remove }} --force"
      delegate_to: "{{ first_node }}"
      run_once: true
      changed_when: true
