# Copyright (C) 2020, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0

# This playbook configures and sets up Ceph.

---
- name: Prepare Ceph installation
  hosts:
      osds
  become: true
  gather_facts: yes
  roles:
    - ceph_prepare_installation

- name: Ceph Expansion VG
  hosts:
      osds
  become: true
  gather_facts: yes
  roles:
    - ceph_expansion_vg

- name: Ceph Expansion LV
  hosts:
      osds
  become: true
  gather_facts: yes
  serial: 1
  roles:
    - ceph_expansion_lv

- name: Ceph OSD hosts pre-configuration
  hosts: osds
  tasks:
    - name: Disable private tmpfs for ceph configuration
      when: seapath_distro == "Yocto"
      block:
        - name: Create /run/systemd/system/sshd@.service.d directory
          file:
            path: /run/systemd/system/sshd@.service.d
            state: directory
        - name: Temporarily disable private tmpfs for ssh sessions
          copy:
            dest: /run/systemd/system/sshd@.service.d/99-temp-disable-private-tmp.conf
            content: |
              [Service]
              PrivateTmp=no
        - name: Reload systemd daemon
          systemd:
            daemon_reload: true
    - name: Reset Ansible SSH connection
      meta: reset_connection

- import_playbook: ../ceph-ansible/site.yml

- name: Ceph OSD hosts post-configuration
  hosts: osds
  tasks:
    - name: Enable again private tmpfs after ceph installation
      when: seapath_distro == "Yocto"
      block:
        - name: Delete temporary sshd service override
          file:
            path: /run/systemd/system/sshd@.service.d/99-temp-disable-private-tmp.conf
            state: absent
        - name: Reload systemd daemon
          systemd:
            daemon_reload: true
    - name: Reset Ansible SSH connection
      meta: reset_connection

# Ceph mgr module which is enabled by default is not supported by SEAPATH.
- name: Disable unwanted Ceph mgr module
  hosts:
      mons
  become: true
  tasks:
      - name: Disable Ceph mgr restful module
        command: ceph mgr module disable restful
        run_once: true
- name: Configure rbd
  hosts:
      osds
  become: true
  tasks:
      - name: Disable rbd lock
        command: rbd config global set global rbd_default_features 'layering, deep-flatten'
        run_once: true
