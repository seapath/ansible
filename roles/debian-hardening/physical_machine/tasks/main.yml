# Copyright (C) 2022-2023, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0
---

- name: "Force loading nf_conntrack at boot"
  lineinfile:
    dest: /etc/modules-load.d/modules.conf
    regexp: "^nf_conntrack$"
    line: "nf_conntrack"
    state: present
  when: not revert
- name: "Disable force loading nf_conntrack at boot"
  lineinfile:
    dest: /etc/modules-load.d/modules.conf
    regexp: "^nf_conntrack$"
    state: absent
  when: revert

- name: Get ceph disk stats
  stat:
    path: "{{ ceph_osd_disk }}"
  register: ceph_osd_disk_stat
  when: ceph_osd_disk is defined
- name: Restrict ceph sudoers file
  template:
    src: ../src/debian/sudoers/ceph.j2
    dest: /etc/sudoers.d/ceph-osd-smartctl
    owner: root
    group: root
    mode: '0440'
  when: not revert

- name: adding sudo users to group privileged
  user:
    name: "{{ item }}"
    groups: privileged
    append: yes
  with_items:
   - ceph
   - Debian-snmp
  when: not revert

