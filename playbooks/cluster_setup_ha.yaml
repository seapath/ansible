# Copyright (C) 2020, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0

# Ansible playbook that creates the cluster by configuring Corosync and
# Pacemaker. It is called by the playbook cluster_setup_main.yaml, but it can
# also be called independently.

---
- name: Setup Corosync
  hosts: cluster_machines
  vars_files:
      - ../vars/corosync_vars.yaml
  roles:
      - corosync

- name: Setup Pacemaker
  hosts: cluster_machines
  tasks:
      - name: Start Pacemaker
        ansible.builtin.systemd:
            name: pacemaker
            state: started
            enabled: true
      - name: wait for pacemaker
        command: crm status
        register: result
        until: result.rc == 0
        retries: 3
        delay: 1
      - name: Disable stonith
        shell: crm configure property stonith-enabled=false
        run_once: true
      - name: Save cluster machine informations
        template:
            src: ../templates/cluster.conf.j2
            dest: /etc/cluster.conf
