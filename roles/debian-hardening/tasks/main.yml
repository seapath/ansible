# Copyright (C) 2022, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0
---

- name: "Add kernel parameters in grub"
  lineinfile:
    dest: /etc/default/grub
    regexp: "^(GRUB_CMDLINE_LINUX=(?!.* {{ item }})\"[^\"]*)(\".*)"
    line: '\1 {{ item }}\2'
    state: present
    backrefs: yes
  register: updategrub
  with_items: "{{ kernel_params }}"
  notify: update-grub
  when: not revert

- name: "Revert kernel parameters added in grub"
  lineinfile:
    dest: /etc/default/grub
    regexp: "^(GRUB_CMDLINE_LINUX=\".*)( {{ item }})(.*\")$"
    line: '\1\3'
    state: present
    backrefs: yes
  register: updategrub
  with_items: "{{ kernel_params }}"
  notify: update-grub
  when: revert


- name: "Disable coredumps"
  lineinfile:
    dest: /etc/sysctl.d/50-coredump.conf
    regexp: "^kernel.core_pattern=/dev/null$"
    line: "kernel.core_pattern=/dev/null"
    create: yes
    state: present
  notify: update sysfs values using sysctl
  when: not revert
- name: "Revert coredump disabling"
  lineinfile:
    dest: /etc/sysctl.d/50-coredump.conf
    regexp: "^kernel.core_pattern=/dev/null$"
    state: absent
  notify: update sysfs values using sysctl
  when: revert

- name: "Disable kexec"
  lineinfile:
    dest: /etc/sysctl.d/50-kexec.conf
    regexp: "^kernel.kexec_load_disabled=1$"
    line: "kernel.kexec_load_disabled=1"
    create: yes
    state: present
  notify: update sysfs values using sysctl
  when: not revert
- name: "Revert kexec disabling"
  lineinfile:
    dest: /etc/sysctl.d/50-kexec.conf
    regexp: "^kernel.kexec_load_disabled=1$"
    state: absent
  notify: update sysfs values using sysctl
  when: revert

- name: "Disable binfmt_misc"
  lineinfile:
    dest: /etc/sysctl.d/50-binfmt_misc.conf
    regexp: "^fs.binfmt_misc.status=0$"
    line: "fs.binfmt_misc.status=0"
    create: yes
    state: present
  notify: update sysfs values using sysctl
  when: not revert
- name: "Revert binfmt_misc disabling"
  lineinfile:
    dest: /etc/sysctl.d/50-binfmt_misc.conf
    regexp: "^fs.binfmt_misc.status=0$"
    state: absent
  notify: update sysfs values using sysctl
  when: revert

- name: "Install hardened sysfs rules"
  copy:
    src: ../src/debian/90-sysctl-hardening.conf
    dest: /etc/sysctl.d/90-sysctl-hardening.conf
  notify: update sysfs values using sysctl
  when: not revert
- name: "Uninstall hardened sysfs rules"
  file:
    path: /etc/sysctl.d/90-sysctl-hardening.conf
    state: absent
  notify: update sysfs values using sysctl
  when: revert

- name: "Install network hardened sysfs rules"
  copy:
    src: ../src/debian/99-sysctl-network.conf
    dest: /etc/sysctl.d/99-sysctl-network.conf
  notify: update sysfs values using sysctl
  when: not revert
- name: "Uninstall network hardened sysfs rules"
  file:
    path: /etc/sysctl.d/99-sysctl-network.conf
    state: absent
  notify: update sysfs values using sysctl
  when: revert

- name: "Force loading nf_conntrack at boot"
  lineinfile:
    dest: /etc/modules-load.d/modules.conf
    regexp: "^nf_conntrack$"
    line: "nf_conntrack"
    state: present
  when: not revert
- name: "Disable force loading nf_conntrack at boot"
  lineinfile:
    dest: /etc/modules-load.d/modules.conf
    regexp: "^nf_conntrack$"
    state: absent
  when: revert

- name: "Install random-root-passwd.service"
  copy:
    src: ../src/debian/random-root-passwd.service
    dest: /etc/systemd/system/random-root-passwd.service
  notify: reload systemd
  when: not revert
  register: randomRoot
- name: "enable random-root-passwd.service"
  ansible.builtin.systemd:
    name: random-root-passwd.service
    enabled: yes
    state: started
  when: not revert and randomRoot.changed
- name: "Disable random-root-passwd.service"
  file:
    path: /etc/systemd/system/sysinit.target.wants/random-root-passwd.service
    state: absent
  when: revert
- name: "Uninstall random-root-passwd.service"
  file:
    path: /etc/systemd/system/random-root-passwd.service
    state: absent
  when: revert
  notify: reload systemd
  register: randomRoot
