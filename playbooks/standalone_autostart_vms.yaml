---
- name: Deploy and start the systemd service to start all VMs at boot
  hosts: standalone_machine
  become: yes
  tasks:

    - name: Create the systemd service file
      copy:
        dest: /etc/systemd/system/start-vms-on-boot.service
        content: |
          [Unit]
          Description=Start all VMs at boot
          After=network.target libvirtd.service

          [Service]
          Type=oneshot
          ExecStart=/bin/bash -c 'for i in $(virsh list --all | awk '\''{print $2}'\'' | grep -v Name); do virsh start $i; done'
          RemainAfterExit=true

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd to apply the new service
      command: systemctl daemon-reload

    - name: Enable the service to start at boot
      systemd:
        name: start-vms-on-boot
        enabled: yes

    - name: Start the service
      systemd:
        name: start-vms-on-boot
        state: started
