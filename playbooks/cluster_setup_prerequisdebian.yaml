# Copyright (C) 2023, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0

- name: Prerequis machine debian
  gather_facts: True
  hosts:
    - cluster_machines
    - standalone_machine
    - VMs
  become: true
  roles:
    - debian
- name: Prerequis physical machine debian
  gather_facts: True
  hosts:
    - cluster_machines
    - standalone_machine
  become: true
  roles:
    - debian/physical_machine
- name: Prerequis hypervisor debian
  hosts:
    - hypervisors
    - standalone_machine
  become: true
  roles:
    - debian/hypervisor

- name: Disable libvirt-guests.service
  hosts:
    - cluster_machines
  become: true
  tasks:
    - name: disable libvirt-guests.service
      ansible.builtin.systemd:
        name: libvirt-guests.service
        enabled: no
        state: stopped

- name: Remove what is not needed after installation
  hosts:
    - cluster_machines
    - standalone_machine
    - VMs
  become: true
  tasks:
    - name: Uninstall apt packages not required after installation
      apt:
        name:
          - fdisk
          - ifupdown
          - libfdisk1
        state: absent
        purge: yes
        autoremove: yes
    - name: Disable unused systemd services
      systemd:
        unit: "{{ item }}"
        state: stopped
        enabled: no
        no_block: yes
      with_items:
        - apt-daily-upgrade.timer
        - apt-daily.timer
