# This playbook setup SEAPATH on both debian and CentOS machines
# The machine must previously have been flashed
# with an iso created by build_debian_iso or CentOS with appropriate kickstart file
# This playbooks can also configure VMs created with build_debian_iso

- name: Check if we are using a correct seapath flavor
  hosts:
    - cluster_machines
    - standalone_machine
    - VMs
  tasks:
    - name: Retrieve redhat-release
      stat:
        path: /etc/redhat-release
      register: "redhat_output"

    - name: Retrieve debian-version
      stat:
        path: /etc/debian_version
      register: "debian_output"

    - name: Print both versions
      ansible.builtin.debug:
        msg: redhat_output {{ redhat_output.stat.exists }} debian_output {{ debian_output.stat.exists }}

    - name: Check if current Ansible branch is compatible
      fail:
        msg: "The current branch (debian-main) is incompatible with the Yocto version of SEAPATH. Please use the main branch to configure this machine"
      failed_when:
        - not(redhat_output.stat.exists) and not(debian_output.stat.exists )

- import_playbook: cluster_setup_prerequiscentos.yaml
  when:
    - redhat_output.stat.exists

- import_playbook: cluster_setup_prerequisdebian.yaml
  when:
    - debian_output.stat.exists

- import_playbook: cluster_setup_network.yaml

# Importing cluster playbooks only for cluster machines
- import_playbook: cluster_setup_ceph.yaml
  when:
    - groups['cluster_machines'] is defined
    - inventory_hostname in groups['cluster_machines']
- import_playbook: cluster_setup_libvirt.yaml
  when:
    - groups['cluster_machines'] is defined
    - inventory_hostname in groups['cluster_machines']
- import_playbook: cluster_setup_add_livemigration_user.yaml
  when:
    - groups['cluster_machines'] is defined
    - inventory_hostname in groups['cluster_machines']
- import_playbook: cluster_setup_ha.yaml
  when:
    - groups['cluster_machines'] is defined
    - inventory_hostname in groups['cluster_machines']

- name: Restart all hosts
  hosts:
    - cluster_machines
    - standalone_machine
  become: true
  tasks:
    - name: Restart to configure CentOS
      reboot:
      when:
        - skip_reboot_setup_debian is not defined or not skip_reboot_setup_debian
    - name: Wait for host to be online
      wait_for_connection:
