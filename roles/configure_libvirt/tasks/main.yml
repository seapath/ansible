# Copyright (C) 2024 RTE
# Copyright (C) 2024-2025 Savoir-faire Linux, Inc.
# SPDX-License-Identifier: Apache-2.0

- name: Copy libvirtd.conf
  template:
    src: libvirtd.conf.j2
    dest: /etc/libvirt/libvirtd.conf
    owner: root
    group: root
    mode: 0644
  when:
    - configure_libvirt_allow_non_root_libvirt_socket_access
  register: configure_libvirt_libvirtd_conf

# Restart libvirtd if configuration changed
- name: Restart libvirtd
  ansible.builtin.systemd:
    name: libvirtd
    state: restarted
  when: configure_libvirt_libvirtd_conf.changed # noqa: no-handler

#Â OracleLinux specific
- name: Enable and start virtsecretd.socket
  ansible.builtin.systemd:
    name: virtsecretd.socket
    state: started
    enabled: true
  when: seapath_distro == "OracleLinux"
- name: Enable and start virtqemud.socket
  ansible.builtin.systemd:
    name: virtqemud.socket
    state: started
    enabled: true
  when: seapath_distro == "OracleLinux"
- name: Enable and start virtstoraged.socket
  ansible.builtin.systemd:
    name: virtstoraged.socket
    state: started
    enabled: true
  when: seapath_distro == "OracleLinux"
